<div><style type="text/css">.pdl-layout>div[data-type=layout]{display:flex;justify-content:center;align-items:center;gap:1em}.pdl-layout.legend-bottom>div[data-type=layout]{flex-direction:column}.pdl-layout .pdl-cell[data-name=legend] .pdlg.vertical{min-height:fit-content}</style><script type="@plotdb/block">var mod;module.exports={pkg:{name:"voronoi-treemap",version:"0.0.1",extend:{name:"base",version:"0.0.1"},dependencies:[{name:"@zbryikt/voronoijs",version:"main",path:"index.min.js"}]},init:function(t){var e,i,n;e=t.root,i=t.context,n=t.pubsub;return n.fire("init",{mod:mod({context:i})}).then(function(t){return t[0]})}};mod=function(t){var e,g,f,c,d,i;e=t.context;g=e.d3,f=e.ldcolor,c=e.voronoi,d=e.chart;return{sample:function(){return{raw:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100].map(function(t){return{name:"Node "+t,val:(Math.random()*10).toFixed(2),cat:"C-"+Math.floor(1+10*Math.random())}}),binding:{name:{key:"name"},area:{key:"val"},category:{key:"cat"}}}},config:(i=d.utils.config.from({preset:"default",label:"label",legend:"legend"}),i.voronoi={maxCount:{type:"number",min:1,max:200,step:1,default:100},preserve:{type:"choice",values:["Larger Value","Smaller Value","As Input Order"]}},i.border={color:{type:"color",default:"#fff"},strokeWidth:{type:"number",default:1,min:0,max:100,step:1}},i),dimension:{area:{type:"R",name:"area"},name:{type:"N",desc:"name"},category:{type:"N",desc:"category"}},init:function(){var e,t,n=this;this.tint=e=new d.utils.tint;this.g=Object.fromEntries(["view","legend"].map(function(t){return[t,g.select(n.layout.getGroup(t))]}));this.layout.getGroup("view").appendChild(t=document.createElementNS("http://www.w3.org/2000/svg","g"));this.g.shape=g.select(t);this.siteBoxes=[];this.legend=new d.utils.legend({layout:this.layout,name:"legend",root:this.root,shape:function(t){return g.select(this).attr("fill",e.get(t.key))},cfg:{selectable:true}});this.legend.on("select",function(){n.parse();n.bind();n.resize();return n.render()});this.tip=new d.utils.tip({root:this.root,accessor:function(t){var e,i;e=t.evt;if(!(e.target&&(i=g.select(e.target).datum()))){return null}if(Array.isArray(i)){if(!n._sites){return}if(!(i.idx!=null)){return}if(!(i=n._sites[i.idx])){return}}return{name:i.name,value:n.fmt(i.area||0)+""+((n.binding.area||{}).unit||"")}},range:function(){return n.layout.getNode("view").getBoundingClientRect()}});return this.start()},parse:function(){var t;this.data.map(function(t){return t.key=t.name,t.value=t.area,t});this.partial=this.data.slice(0);if(this.cfg.voronoi.preserve==="Larger Value"){this.partial.sort(function(t,e){return e.value-t.value})}else if(this.cfg.voronoi.preserve==="Smaller Value"){this.partial.sort(function(t,e){return t.value-e.value})}this.partial=this.partial.slice(0,((t=this.cfg).voronoi||(t.voronoi={})).maxCount||100);this.total=this.partial.reduce(function(t,e){return t+e.area},0);this.cats=Array.from(new Set(this.partial.map(function(t){return t.category}))).filter(function(t){return t!=null});return this.legend.data(this.cats.map(function(t){return{key:t,text:t}}))},resize:function(){var t,e,i,n,r,a,s,o,l,h,u=this;this.tip.toggle(((t=this.cfg).tip||(t.tip={})).enabled!=null?this.cfg.tip.enabled:true);this.root.querySelector(".pdl-layout").classList.toggle("legend-bottom",this.cfg.legend.position==="bottom");this.legend.config(import$({},this.cfg.legend));this.legend.update();this.layout.update(false);e=this.root.getBoundingClientRect();i=this.layout.getBox("legend");if(this.cfg.legend.position==="bottom"){t=[e.width,e.height-i.height],n=t[0],r=t[1]}else{t=[e.width-i.width,e.height],n=t[0],r=t[1]}n=r=a=n>r?r:n;t=this.layout.getNode("view").style;t.width=a+"px";t.height=a+"px";this.layout.update(false);this.fmt=d.utils.format.from(this.cfg.label.format);s=this.binding.category?this.partial.filter(function(t){return u.legend.isSelected(t.category)}):this.partial;this.parsed={children:g.nest().key(function(t){return t.category}).entries(s).map(function(t){return t.children=t.values,t})};this.treemap=new c.Treemap(this.parsed,c.Polygon.create(n,r,60),n,r);o=this.treemap.getSites();l=this.g.shape.selectAll("path.data").data(this.treemap.getPolygons());l.exit().remove();l.enter().append("path").attr("class","data").each(function(t,e){return t.idx=e});this.g.shape.selectAll("path.data").attr("class",function(t,e){if(o[e].lv<=0){return"data group"}else{return"data"}});this.polygons=this.g.shape.selectAll("path.data");h=this.g.shape.selectAll("g.label").data(o);h.exit().remove();h.enter().append("g").attr("class","label").each(function(t,e){var i;i=g.select(this);i.append("text").attr("class","name").attr("font-size",".8em");i.append("text").attr("class","value");return i});this.sites=this.g.shape.selectAll("g.label");this.sites.attr("font-size",this.cfg.font.size);this.sites.each(function(t,e){return g.select(this).selectAll("text").data([t,t]).attr("text-anchor","middle").attr("dominant-baseline","center")});this.scale={x:g.scaleLinear().domain([0,n]).range([0,n]),y:g.scaleLinear().domain([0,r]).range([0,r]),color:g.interpolateTurbo};if(this.cfg!=null&&this.cfg.palette){this.scale.color=g.interpolateDiscrete(this.cfg.palette.colors.map(function(t){return f.web(t.value||t)}))}this.tint.set(this.cfg.palette);o=this.treemap.getSites();this.count=0;return this.gbox=this.svg.getBoundingClientRect()},render:function(){var t,i,e,n,r,a,o,c,s=this;t=this.ticking;this.ticking=false;this._sites=i=this.treemap.getSites();e=this.treemap.getPolygons();n=[this.box.width,this.box.height],r=n[0],a=n[1];if(!t){this.legend.render();this.sites.selectAll(".name").attr("dy","0.88em").text(function(t){var e;e=(t.name||"")+"";return e;if(t.lv>0){return e.substring(0,7)+(e.length>7?"...":"")}else{return""}}).attr("fill",function(t,e){if(f.hcl(s.tint.get(t.category)).l>60){return"#000"}else{return"#eee"}}).style("pointer-events","none");this.sites.selectAll(".value").attr("dy","-0.28em").text(function(t){if(t.lv>0){return s.fmt(t.area||0)}else{return""}}).attr("fill",function(t,e){if(f.hcl(s.tint.get(t.category)).l>60){return"#000"}else{return"#eee"}}).style("pointer-events","none");this.siteBoxes=o=[];this.sites.each(function(t,e){return o.push(this.getBoundingClientRect())});this.polygons.attr("fill",function(t,e){return s.tint.get(i[e].category)}).attr("stroke",this.cfg.border.color).attr("stroke-width",this.cfg.border.strokeWidth)}o=this.siteBoxes;c=[];this.polygons.data(e).attr("d",function(t,e){var i,n,r,a,s,o,l,h,u;t.idx=e;if(!(t&&t.length)){c.push({});return""}i=[["M",t[0].x,t[0].y]];n=[{x:t[0].x,y:t[0].y},{x:t[0].x,y:t[0].y}],r=n[0],a=n[1];for(s=0,o=t.length;s<o;++s){l=s;n=[t[l].x,t[l].y],h=n[0],u=n[1];if(r.x>h){r.x=h}if(a.x<h){a.x=h}if(r.y>u){r.y=u}if(a.y<u){a.y=u}i.push(["L",h,u])}i.push(["L",t[0].x,t[0].y]);c.push({x:r.x,y:r.y,width:a.x-r.x,height:a.y-r.y});return i.map(function(t){return t.join(" ")}).join(" ")});this.polygons.attr("opacity",function(t,e){var i,n,r,a;i=c[e];n=i.x+i.width/2;r=i.y+i.height/2;a=isNaN(i.x+i.y+i.width+i.height);if(a){return 0}else{return 1}});return this.sites.each(function(t,e){var n,r,i,a,s;n=c[e];r=o[e];if(!r){r=this.getBoundingClientRect()}i=n.x+n.width/2;a=n.y+n.height/2;s=isNaN(i)||isNaN(a);return g.select(this).attr("transform",function(){var t,e,i;t=n.x+n.width/2;e=n.y+n.height/2;if(s){i=[-1e4,-1e4],t=i[0],e=i[1]}return"translate("+t+", "+e+")"}).attr("opacity",function(){var t,e,i;if(s){return 0}else{return(t=1-6*((e=r.width/((i=n.width)>0?i:0)-1)>0?e:0))>0?t:0}}).style("pointer-events",function(){if(s){return"none"}else{return""}})})},tick:function(){if(!this.treemap){return}this.count=(this.count||0)+1;if(this.count<100){this.ticking=true;this.treemap.compute();return this.render()}}}};function import$(t,e){var i={}.hasOwnProperty;for(var n in e)if(i.call(e,n))t[n]=e[n];return t}</script><div plug="layout"><div class="pdl-layout"><div data-type="layout"><div class="pdl-cell" data-name="view"></div><div class="pdl-cell" data-name="legend"></div></div><div data-type="render"></div></div></div></div>